# Cloudflare Workers ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **OpenNext ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼** ã‚’ä½¿ç”¨ã—ã¦ **Cloudflare Worker** ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒƒã‚¸ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- è¶…ä½Žãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼
- ç„¡æ–™ã® `workers.dev` ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
- R2 ã‚’ä»‹ã—ãŸå®Œå…¨ãª Next.js ISR ã‚µãƒãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

> **Windows ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®é‡è¦ãªæ³¨æ„:** OpenNext ã¨ Wrangler ã¯ã€**ãƒã‚¤ãƒ†ã‚£ãƒ– Windows ç’°å¢ƒã§ã¯å®Œå…¨ã«ã¯ä¿¡é ¼ã§ãã¾ã›ã‚“**ã€‚ä»¥ä¸‹ã®æ–¹æ³•ã‚’æŽ¨å¥¨ã—ã¾ã™ï¼š
>
> - **GitHub Codespaces** ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆå®Œå…¨ã«å‹•ä½œã—ã¾ã™ï¼‰
> - ã¾ãŸã¯ **WSL (Linux)** ã‚’ä½¿ç”¨ã™ã‚‹
>
> ç´”ç²‹ãª Windows ç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ã¯ã€WASM ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å•é¡Œã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

---

## å‰ææ¡ä»¶

1. **Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ï¼ˆåŸºæœ¬çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ååˆ†ã§ã™ï¼‰
2. **Node.js 18ä»¥ä¸Š**
3. **Wrangler CLI** ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé–‹ç™ºä¾å­˜é–¢ä¿‚ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰ï¼š

```bash
npm install -D wrangler
```

4. Cloudflare ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ï¼š

```bash
npx wrangler login
```

> **æ³¨æ„:** æ”¯æ‰•ã„æ–¹æ³•ã®ç™»éŒ²ãŒå¿…è¦ãªã®ã¯ã€ISR ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãŸã‚ã« R2 ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã®ã¿ã§ã™ã€‚åŸºæœ¬çš„ãª Workers ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç„¡æ–™ã§ã™ã€‚

---

## ã‚¹ãƒ†ãƒƒãƒ— 1 â€” ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
```

---

## ã‚¹ãƒ†ãƒƒãƒ— 2 â€” ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

Cloudflare ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã«åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### 1) `.dev.vars` ã®ä½œæˆï¼ˆCloudflare ãƒ­ãƒ¼ã‚«ãƒ«ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ï¼‰

```bash
cp env.example .dev.vars
```

API ã‚­ãƒ¼ã¨è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

### 2) `.env.local` ã‚‚å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆé€šå¸¸ã® Next.js é–‹ç™ºç”¨ï¼‰

```bash
cp env.example .env.local
```

åŒã˜å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

---

## ã‚¹ãƒ†ãƒƒãƒ— 3 â€” ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—ã®é¸æŠž

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ A: R2 ãªã—ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã€ç„¡æ–™ï¼‰

ISR ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä¸è¦ãªå ´åˆã¯ã€R2 ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ï¼š

**1. ã‚·ãƒ³ãƒ—ãƒ«ãª `open-next.config.ts` ã‚’ä½¿ç”¨:**

```ts
import { defineCloudflareConfig } from "@opennextjs/cloudflare/config"

export default defineCloudflareConfig({})
```

**2. ã‚·ãƒ³ãƒ—ãƒ«ãª `wrangler.jsonc` ã‚’ä½¿ç”¨ï¼ˆr2_buckets ãªã—ï¼‰:**

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "main": ".open-next/worker.js",
  "name": "canvas-a-i-o-worker",
  "compatibility_date": "2025-12-08",
  "compatibility_flags": ["nodejs_compat", "global_fetch_strictly_public"],
  "assets": {
    "directory": ".open-next/assets",
    "binding": "ASSETS"
  },
  "services": [
    {
      "binding": "WORKER_SELF_REFERENCE",
      "service": "canvas-a-i-o-worker"
    }
  ]
}
```

**ã‚¹ãƒ†ãƒƒãƒ— 4** ã¸é€²ã‚“ã§ãã ã•ã„ã€‚

---

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ B: R2 ã‚ã‚Šã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå®Œå…¨ãª ISR ã‚µãƒãƒ¼ãƒˆï¼‰

R2 ã‚’ä½¿ç”¨ã™ã‚‹ã¨ **Incremental Static Regeneration (ISR)** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¯ Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ”¯æ‰•ã„æ–¹æ³•ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚

**1. R2 ãƒã‚±ãƒƒãƒˆã®ä½œæˆ**ï¼ˆCloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¦ï¼‰:

- **Storage & Databases â†’ R2** ã¸ç§»å‹•
- **Create bucket** ã‚’ã‚¯ãƒªãƒƒã‚¯
- åå‰ã‚’å…¥åŠ›: `next-inc-cache`

**2. `open-next.config.ts` ã®è¨­å®š:**

```ts
import { defineCloudflareConfig } from "@opennextjs/cloudflare/config"
import r2IncrementalCache from "@opennextjs/cloudflare/overrides/incremental-cache/r2-incremental-cache"

export default defineCloudflareConfig({
  incrementalCache: r2IncrementalCache,
})
```

**3. `wrangler.jsonc` ã®è¨­å®šï¼ˆR2 ã‚ã‚Šï¼‰:**

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "main": ".open-next/worker.js",
  "name": "canvas-a-i-o-worker",
  "compatibility_date": "2025-12-08",
  "compatibility_flags": ["nodejs_compat", "global_fetch_strictly_public"],
  "assets": {
    "directory": ".open-next/assets",
    "binding": "ASSETS"
  },
  "r2_buckets": [
    {
      "binding": "NEXT_INC_CACHE_R2_BUCKET",
      "bucket_name": "next-inc-cache"
    }
  ],
  "services": [
    {
      "binding": "WORKER_SELF_REFERENCE",
      "service": "canvas-a-i-o-worker"
    }
  ]
}
```

> **é‡è¦:** `bucket_name` ã¯ Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä½œæˆã—ãŸåå‰ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## ã‚¹ãƒ†ãƒƒãƒ— 4 â€” workers.dev ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ²ï¼ˆåˆå›žã®ã¿ï¼‰

åˆå›žãƒ‡ãƒ—ãƒ­ã‚¤ã®å‰ã«ã€workers.dev ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 1: Cloudflare ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµŒç”±ï¼ˆæŽ¨å¥¨ï¼‰**

ã‚¢ã‚¯ã‚»ã‚¹å…ˆ: https://dash.cloudflare.com â†’ Workers & Pages â†’ Overview â†’ Set up a subdomain

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 2: ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚**

`npm run deploy` ã‚’å®Ÿè¡Œã—ãŸéš›ã€Wrangler ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å°‹ã­ã¦ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼š

```
Would you like to register a workers.dev subdomain? (Y/n)
```

`Y` ã‚’å…¥åŠ›ã—ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’é¸æŠžã—ã¦ãã ã•ã„ã€‚

> **æ³¨æ„:** CI/CD ã‚„éžå¯¾è©±åž‹ç’°å¢ƒã§ã¯ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚äº‹å‰ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚

---

## ã‚¹ãƒ†ãƒƒãƒ— 5 â€” Cloudflare ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npm run deploy
```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡¦ç†å†…å®¹ï¼š

- Next.js ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰
- OpenNext ã‚’ä»‹ã—ãŸ Cloudflare Worker ã¸ã®å¤‰æ›
- é™çš„ã‚¢ã‚»ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- Worker ã®å…¬é–‹

ã‚¢ãƒ—ãƒªã¯ä»¥ä¸‹ã® URL ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š

```
https://<worker-name>.<your-subdomain>.workers.dev
```

---

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

### `You need to register a workers.dev subdomain`

**åŽŸå› :** ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« workers.dev ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

**è§£æ±ºç­–:** https://dash.cloudflare.com â†’ Workers & Pages â†’ Set up a subdomain ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚

---

### `Please enable R2 through the Cloudflare Dashboard`

**åŽŸå› :** `wrangler.jsonc` ã§ R2 ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ R2 ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚

**è§£æ±ºç­–:** R2 ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆæ”¯æ‰•ã„æ–¹æ³•ãŒå¿…è¦ï¼‰ã‹ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ Aï¼ˆR2 ãªã—ã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

---

### `No R2 binding "NEXT_INC_CACHE_R2_BUCKET" found`

**åŽŸå› :** `wrangler.jsonc` ã« `r2_buckets` ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

**è§£æ±ºç­–:** `r2_buckets` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ Aï¼ˆR2 ãªã—ï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„ã€‚

---

### `Can't set compatibility date in the future`

**åŽŸå› :** wrangler è¨­å®šã® `compatibility_date` ãŒæœªæ¥ã®æ—¥ä»˜ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

**è§£æ±ºç­–:** `compatibility_date` ã‚’ä»Šæ—¥ã¾ãŸã¯ãã‚Œä»¥å‰ã®æ—¥ä»˜ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

---

### Windows ã‚¨ãƒ©ãƒ¼: `resvg.wasm?module` (ENOENT)

**åŽŸå› :** Windows ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ã¯ `?` ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ãŒã€wasm ã‚¢ã‚»ãƒƒãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«åã« `?module` ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

**è§£æ±ºç­–:** Linux ç’°å¢ƒï¼ˆWSLã€Codespacesã€ã¾ãŸã¯ CIï¼‰ã§ãƒ“ãƒ«ãƒ‰/ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚

---

## ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã« Worker ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ï¼š

```bash
npm run preview
```

---

## ã¾ã¨ã‚

| æ©Ÿèƒ½ | R2 ãªã— | R2 ã‚ã‚Š |
|---------|------------|---------|
| ã‚³ã‚¹ãƒˆ | ç„¡æ–™ | æ”¯æ‰•ã„æ–¹æ³•ãŒå¿…è¦ |
| ISR ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ãªã— | ã‚ã‚Š |
| é™çš„ãƒšãƒ¼ã‚¸ | ã‚ã‚Š | ã‚ã‚Š |
| API ãƒ«ãƒ¼ãƒˆ | ã‚ã‚Š | ã‚ã‚Š |
| è¨­å®šã®è¤‡é›‘ã• | ã‚·ãƒ³ãƒ—ãƒ« | æ™®é€š |

ãƒ†ã‚¹ãƒˆã‚„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒªã«ã¯ **R2 ãªã—** ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ISR ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªæœ¬ç•ªã‚¢ãƒ—ãƒªã«ã¯ **R2 ã‚ã‚Š** ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
